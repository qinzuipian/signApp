<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>èŠå¤©çª—å£</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/chatWindow.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav header-blue">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title bind-title" id="chatNameDom"></h1>
		</header>

		<div id="app_error" style="display: block;"></div>

		<div id="app" style="display: none;">
			<div class="chat-content-box" id="chatContentBox">
				<!-- <div class="chatlist-loding" v-show="hasHistory">
					<button type="button" id="loadingMoreHistory" data-loading-text="æ­£åœ¨åŠ è½½" class="mui-btn" @click="loadingMore()">ç‚¹å‡»åŠ è½½æ›´å¤š</button>
				</div> -->
				<p class="nomoreHistory" v-show="!hasHistory">æ²¡æœ‰æ›´æ—©çš„å†å²è®°å½•äº†</p>
				<!-- <div v-if="pushMessage.length!=0">
					<p class="sender-name"></p>
					<div class="sender-box">
						<div>
							<img src="../../img/msg/jiqiren.png">
						</div>
						<p v-text="pushMessage"></p>
					</div>
				</div> -->
				<div v-for="(it, index) in chatList" class="chatmsgbox">
					<div v-if="it.msgType == 'text'">
						<div v-if="it.senderId != 3">
							<div v-if="it.reply.length!=0">
								<p class="sender-name" v-text="it.senderName"></p>
								<div class="sender-box">
									<div>
										<img src="../../img/msg/jiqiren.png">
									</div>
									<p v-text="it.reply"></p>
								</div>
							</div>
						</div>
						
						<div v-if="it.senderId != 3">
							<div v-if="it.remind.length!=0">
								<p class="sender-name" v-text="it.senderName"></p>
								<div class="sender-box">
									<div>
										<img src="../../img/msg/jiqiren.png">
									</div>
									<p v-text="it.remind"></p>
								</div>
							</div>
						</div>
						
						<div v-if="it.senderId != 3">
							<div v-if="it.content.length!=0">
								<p class="sender-name" v-text="it.senderName"></p>
								<div class="sender-box">
									<div>
										<img src="../../img/msg/jiqiren.png">
									</div>
									<p v-text="it.content"></p>
								</div>
							</div>
							
						</div>
						
						<div v-if="it.senderId != 3 && it.tag.length!=0">
							<p class="sender-name" v-text="it.senderName"></p>
							<div class="sender-box">
								<div>
									<img src="../../img/msg/jiqiren.png">
								</div>
								<ul>
									<li  v-for="(it, index) in it.tag">
										<span v-text="it"></span>
									</li>
								</ul>
							</div>
						</div>

						<div v-if="it.senderId == 3">
							<p class="sender-name-self" v-text="it.senderName"></p>
							<div class="sender-box-self">
								<div>
									<img src="../../img/msg/huanzhe.png">
								</div>
								<p v-text="it.content"></p>
							</div>
						</div>
					</div>

				<div v-if="it.msgType == 'voice'">
						<div v-if="it.senderId != 3">
							<p class="sender-name" v-text="it.senderName"></p>
							<div class="sender-box">
								<div>
									<img src="../../img/msg/jiqiren.png">
								</div>
								<p @click="playThisAudio(it, index)" :style="{width: it.widthLength}" :class="{activeAudio: it.isPlay == 1}" v-text="it.duration"></p>
							</div>
						</div>

						<div v-if="it.senderId == 3">
							<p class="sender-name-self" v-text="it.senderName"></p>
							<div class="sender-box-self">
								<div>
									<img src="../../img/msg/huanzhe.png">
								</div>
								<p @click="playThisAudio(it, index)" :style="{width: it.widthLength}" :class="{activeAudio: it.isPlay == 1}"
								 v-text="it.duration"></p>
							</div>
						</div>
					</div>

				</div>
			</div>

			<div class="footer-content" id="footerContent">
				<div class="voice-icon" id="voiceIconBox" style="display: block;">
					<i class="mui-icon mui-icon-mic"></i>
				</div>

				<div class="voice-icon" id="textIconBox" style="display: none;">
					<i class="mui-icon mui-icon-compose"></i>
				</div>

				<div class="input-content">
					<textarea name="msgContent" id="messageCon" cols="20" rows="1" style="display: block;"></textarea>
					<button type="button" id="holdToSpeak" class="mui-btn mui-btn-outlined hold-to-speak" style="display: none;">æŒ‰ä½è¯´è¯</button>
				</div>
				<div class="more-menu" id="moreIcon" style="display: block;">
					<i class="mui-icon mui-icon-plus"></i>
				</div>
				<div class="more-menu" id="sendBtn" style="display: none;">
					<span>å‘é€</span>
				</div>
			</div>

			<!-- <div class="more-box" id="morBox" style="display: none;">
				<div class="item-box">
					<ul class="mui-table-view item-icon-box">
						<li class="mui-table-view-cell item-icon">
							<img src="../../img/index/paizhao.png">
						</li>
					</ul>
					<p>æ‹ç…§</p>
				</div>

				<div class="item-box">
					<ul class="mui-table-view item-icon-box">
						<li class="mui-table-view-cell item-icon">
							<img src="../../img/index/xiangce.png">
						</li>
					</ul>
					<p>ç›¸å†Œ</p>
				</div>

				<div class="item-box">
					<ul class="mui-table-view item-icon-box">
						<li class="mui-table-view-cell item-icon">
							<img src="../../img/index/yuyinliaotian.png">
						</li>
					</ul>
					<p>è¯­éŸ³èŠå¤©</p>
				</div>

				<div class="item-box">
					<ul class="mui-table-view item-icon-box">
						<li class="mui-table-view-cell item-icon">
							<img src="../../img/index/shipinliaotian.png">
						</li>
					</ul>
					<p>è§†é¢‘</p>
				</div>
			</div> -->

			<div class="microphone" id="microphoneBox" style="display: none;">
				<img src="../../img/msg/microphone.png">
				<p id="microphoneNum">60</p>
			</div>

			<div class="microphone" id="microphoneBoxShort" style="display: none;">
				<img src="../../img/msg/jinggao.png">
				<p style="font-size: 14px;">å½•éŸ³æ—¶é—´å¤ªçŸ­</p>
			</div>

		</div>



		<script src="../../js/mui.js"></script>
<!-- 		<script src="https://cdn.ronghub.com/RongIMLib-2.4.0.min.js"></script> -->
		<script src="../../js/vue.min.js"></script>
		<script src="../../js/common.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: false, //å¯ç”¨å³æ»‘å…³é—­åŠŸèƒ½
				beforeback: function() {
					closeActivePage();
					// mui.fire(msgPage, 'chatWindowClose')
				},
				gestureConfig: {
					tap: true, //é»˜è®¤ä¸ºtrue
					longtap: true, //é»˜è®¤ä¸ºfalse
					hold: true, //é»˜è®¤ä¸ºfalseï¼Œä¸ç›‘å¬
					release: true //é»˜è®¤ä¸ºfalseï¼Œä¸ç›‘å¬
				}
			});

			var audioObj = null; // å½•éŸ³å¯¹è±¡
			var playThisAudioObj = null; // æ’­æ”¾è¯­éŸ³å¯¹è±¡
			var audioPath = null; // å½•éŸ³è·¯å¾„
			var voiceTime; // å€’è®¡æ—¶ -- å®šæ—¶å™¨
			var isHoldEven = false; // åˆ¤æ–­æ˜¯å¦ä¸ºé•¿æŒ‰,   å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥,ç‚¹å‡»ä¹‹åä¹Ÿä¼šæ‰§è¡Œreleaseå‡½æ•°;

			var app = new Vue({
				el: "#app",
				data: {
					chatUserId: 3, // è‡ªå·±çš„ID
					chatUserName: "æ‚£è€…",
					hasHistory: true, // æ˜¯å¦æœ‰å†å²è®°å½•
					chatList: [
 							/* {
 								senderName: "å°è‰¾",
 								senderId: 2,
								content: "ä¸‹åˆå¥½",
								msgType: "text",
								tag:["ç—‡çŠ¶åŠ é‡","å‡ºç°å¹¶å‘ç—‡","ç”¨è¯ä¸è‰¯ååº”","å¸çƒŸé¥®é…’","è¡€å‹120.0ï¼›ä½å‹60.0","é¥®é£Ÿæ§åˆ¶å·®"]
							},
							{
								senderName: "æ‚£è€…",
								senderId: 3,
								content: "ä¸‹åˆå¥½",
								msgType: "text"
							} */
					],
					audio:"",
					pushMessage:"",
					souce:""
					/* reply:"",
					remind:"",*/
					
				},
				methods: {
					// ç‚¹å‡»æ’­æ”¾è¯­éŸ³
					playThisAudio: function(it, index) {
						console.log(JSON.stringify(it, index))
						playThisAudioObj = plus.audio.createPlayer(it.voicePath);

						if (it.isPlay == 0) { // ç‚¹äº†ä¸€ä¸‹,éœ€è¦æ’­æ”¾è¯­éŸ³
							it.isPlay = 1;
							for (var i = 0; i < this.chatList.length; i++) { // å¾ªç¯æŸ¥æ‰¾å½“å‰æœ‰æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
								if (i != index) { // å¦‚æœå½“å‰å¾ªç¯é¡¹ä¸æ˜¯å½“å‰ç‚¹å‡»é¡¹
									if (this.chatList[i].isPlay == 1) { // å¦‚æœå½“å‰å¾ªç¯é¡¹æ­£åœ¨æ’­æ”¾
										this.chatList[i].isPlay = 0; // å…³é—­å½“å‰æ’­æ”¾çš„è¯­éŸ³
									}
								}
							}
							// æ’­æ”¾å½•éŸ³
							if (plus.audio == undefined) {
								alert("æ’­æ”¾å‡ºé”™,è¯·æ£€æŸ¥æ˜¯å¦æ”¯æŒæ’­æ”¾åŠŸèƒ½");
							};
							playThisAudioObj.play(function() {
								console.log("æ’­æ”¾å®Œæ¯•");
								// æ’­æ”¾å®Œæ¯•
								it.isPlay = 0;
							}, function(e) {
								console.log("Audio play error: " + e.message);
								it.isPlay = 0;
							});
							app.$forceUpdate(); // é‡æ–°æ¸²æŸ“DOM

						} else if (it.isPlay == 1) { // ç‚¹äº†ä¸€ä¸‹,éœ€è¦åœæ­¢æ’­æ”¾
						console.log(2)
							playThisAudioObj.stop();
							it.isPlay = 0;
							app.$forceUpdate(); // é‡æ–°æ¸²æŸ“DOM
						}
					}
				}
			});
			
			var sugId,pushId,suifangType;
			//å½“dataFlag==1æ—¶,ä¸ºæ–‡å­—èŠå¤©,å½“dataFlag==2æ—¶,ä¸ºè¯­éŸ³èŠå¤©
			var dataFlag = 1;
			function accompanyDetail() {
				var ws = plus.webview.currentWebview();
				console.log(JSON.stringify(ws));				
				sugId = ws.accompanyDetail;
				// pushId = ws.accompanyPush.title
				if(sugId == "é«˜è¡€å‹") {
					suifangType = 'GXYSF'
				}
				else if(sugId == "ç³–å°¿ç—…"){
					suifangType = 'TNBSF'
				}
				
				if(ws.accompanyPush) {
					// alert(JSON.stringify(ws.accompanyPush))
					if(ws.accompanyPush.title=='æ–°æ¶ˆæ¯GXYSF') {
						suifangType = 'GXYSF'
					} else if(ws.accompanyPush.title=='æ–°æ¶ˆæ¯TNBSF') {
						suifangType = 'TNBSF'
					}
					app.pushMessage = ws.accompanyPush.content;
					var obj = {
						senderId: 2,
						// senderId: app.chatUserId,
						// senderName: app.chatUserName,
						senderName: 'éšè®¿æŠ¤å£«',
						content: app.pushMessage,
						remind: "",
						reply: "",
						tag:"",
						msgType: "text"
					
					};
					app.chatList.push(obj);
					console.log(JSON.stringify(app.chatList))
				} else {
					
				}
				
				
			}
			var messageCon = document.getElementById("messageCon"); // è¾“å…¥æ¡†
			var moreIcon = document.getElementById("moreIcon"); // æ›´å¤š æŒ‰é’®
			var sendBtn = document.getElementById("sendBtn"); // å‘é€æŒ‰é’®
			var morBox = document.getElementById("morBox"); // æ›´å¤šåŒºåŸŸ
			var chatContentBox = document.getElementById("chatContentBox"); // èŠå¤©å†…å®¹åŒºåŸŸ
			var voiceIconBox = document.getElementById("voiceIconBox"); // è¯­éŸ³è¾“å…¥
			var holdToSpeak = document.getElementById("holdToSpeak"); // æŒ‰ä½è¯´è¯
			var textIconBox = document.getElementById("textIconBox"); // ç‚¹å‡»åˆ‡æ¢åˆ°ç¼–è¾‘æ–‡æœ¬
			var microphoneBox = document.getElementById("microphoneBox"); // éº¦å…‹é£æç¤ºæ¡†
			var microphoneNum = document.getElementById("microphoneNum"); // è¯­éŸ³è¾“å…¥å€’è®¡æ—¶
			var microphoneBoxShort = document.getElementById("microphoneBoxShort"); // å½•éŸ³æ—¶é—´å¤ªçŸ­
			var footerContent = document.getElementById("footerContent"); // åº•éƒ¨è¾“å…¥å—

			// var ryAppKey, ryToken, targetId; // èäº‘çš„appkeyå’Œtoken

			var targetId; // èŠå¤©å¯¹è±¡çš„ID
			var msgPage;
			mui.plusReady(function() {
			/* 	var id_emergency = plus.webview.currentWebview().accompanyPush;
				app.pushMessage = id_emergency.content;
				var pushstyle = id_emergency.title;
				if(pushstyle == "æ–°æ¶ˆæ¯GXYSF") {
					suifangType = 'GXYSF'
				}
				else if(pushstyle == "æ–°æ¶ˆæ¯TNBSF"){
					suifangType = 'TNBSF'
				}
				var obj = {
					senderId: 3,
					// senderId: app.chatUserId,
					senderName: app.chatUserName,
					content: app.pushMessage,
					msgType: "text",
					reply:"",
					remind:"",
				
				};
				app.chatList.push(obj);
				console.log(JSON.stringify(app.chatList)) */
				
				getStorageDate();
				chatWindowInit();
				//æ¥å—çˆ¶é¡µé¢ä¼ è¿‡æ¥çš„å‚æ•°
				accompanyDetail();
				//æ¥å—indexé¡µé¢æ¨é€çš„ä¿¡æ¯
				// accompanyPush();

				// æ˜¾ç¤ºèŠå¤©å¯¹è±¡
				// var ws = plus.webview.currentWebview();
				document.getElementById("chatNameDom").innerHTML = 'éšè®¿æŠ¤å£«';
				// chatwithInit("2",dataFlag);
				// targetId = ws.chatObj.doctorNo;
	/* 			for (var i = 0; i < ws.chatHistoryList.length; i++) {
					var obj = {};
					if (ws.chatHistoryList[i].senderUserId == app.chatUserId) {
						obj.senderName = userName;
						obj.senderId = userId;
					} else {
						obj.senderName = ws.chatObj.doctorName;
						obj.senderId = ws.chatObj.doctorNo;
					}

					obj.content = ws.chatHistoryList[i].content.content;

					if (ws.chatHistoryList[i].messageType = "TextMessage") {
						obj.msgType = "text"
					}
					app.chatList.push(obj);
				}; */
				//èŠå¤©å†å²çºªå½•
				historyList();
				
				setTimeout(function() {
					chatContentBox.scrollTop = chatContentBox.scrollHeight;
				}, 10)


				// èŠå¤©åˆ—è¡¨é¡µé¢
				// msgPage = plus.webview.getWebviewById("msg");

				document.getElementById("app_error").style.display = "none";
				document.getElementById("app").style.display = "block"


			});
			/* function accompanyPush() {
				var ws = plus.webview.currentWebview();
				console.log(JSON.stringify(ws));
				// chatwithInit("ä½ å¥½",dataFlag);
			} */
			
			//æŸ¥è¯¢èŠå¤©å†å²çºªå½•
			function historyList() {
				var data = JSON.stringify({
					personId: personId,
					qaType:suifangType
				})
				console.log(data)
				plus.nativeUI.showWaiting("ç­‰å¾…ä¸­...");
				mui.ajax(JTURL + 'jkda/heathai/queryHeathAiConversionByPersonId', {
					data: data,
					dataType: 'json', //æœåŠ¡å™¨è¿”å›jsonæ ¼å¼æ•°æ®
					headers: {
						'Content-Type': 'application/json'
					},
					type: 'post', //HTTPè¯·æ±‚ç±»å‹
					timeout: 10000, //è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10ç§’ï¼›					
					success: function(res) {
						console.log(JSON.stringify(res))
						if(res.code == 0) {
							// plus.nativeUI.closeWaiting();
							var chatData = res.data;
							for(var i=0;i<chatData.length;i++) {
									if(chatData[i].questiontype == 1) {
										/* var taglist = [];
										taglist.push(chatData[i].tag); */
										var nurseobj = {
											senderId: 2,
											// senderId: app.chatUserId,
											// senderName: app.chatUserName,
											senderName: 'éšè®¿æŠ¤å£«',
											content: chatData[i].question,
											remind: chatData[i].remind,
											reply: chatData[i].reply,
											tag:chatData[i].tag,
											msgType: "text"
										};
										
										var patientobj = {
											senderId: 3,
											// senderId: app.chatUserId,
											senderName: app.chatUserName,
											content: chatData[i].lastreply,
											msgType: "text",
											reply:"",
											remind:"",										
										};
										app.chatList.push(nurseobj,patientobj);
									} else if(chatData[i].questiontype == 2) {
										var base64Str = chatData[i].video;
										var lastbase64Str = chatData[i].lastreply;
										var toURL;
										// å½•éŸ³å®Œæ¯•,ä¿å­˜åœ¨æœ¬åœ°,å¹¶å±•ç¤ºåœ¨é¡µé¢
										var l = 60 - microphoneNum.innerHTML; // è¯­éŸ³é•¿åº¦
										var widthNum = plus.display.resolutionWidth * 0.9 - 100;
										var ratio = (widthNum - 50) / 60;								
										// console.log(ratio);
										dataURL2Audio(base64Str, function(entry){
												toURL = entry.toURL();	
												app.audio = toURL;
												console.log(app.audio)
												var nurseobj = {
														// senderId: app.chatUserId,
														senderId: 2,
														senderName: 'éšè®¿æŠ¤å£«',
														// voicePath: audioPath,
														voicePath: app.audio,
														//duration: l + "s",
														duration: "ğŸ”Š",
														msgType: "voice",
														widthLength: ratio * l + 50 + "px",
														isPlay: 0
													};
										
												app.chatList.push(nurseobj);
										
										})
										
										dataURL2Audio(lastbase64Str, function(entry){
												toURL = entry.toURL();	
												app.audio = toURL;
												console.log(app.audio)
												var patientobj = {
													// senderId: app.chatUserId,
													senderId: 3,
													senderName: app.chatUserName,
													voicePath: app.audio,
													duration:"ğŸ”Š",
													msgType: "voice",
													widthLength: ratio * l + 50 + "px",
													isPlay: 0
												};
												app.chatList.push(patientobj);
										
										})
										
									} 
								
								
						}
						chatscroll();
						plus.nativeUI.closeWaiting();
					}
					},
					error: function(xhr, type, errorThrown) {
						console.log(type);
					}
				});
			} 
			
			
			//æŸ¥è¯¢AIä¸ç—…äººçš„èŠå¤©åˆ—è¡¨
			function chatwithInit(msg,type) {
				console.log(JSON.stringify("msg"+msg+","+"type"+type))
				if(type == 1) {
					var data=JSON.stringify({
					reqData:{
					userId:personId,
					questionType:1,
					lastReply:msg,
					qaType:suifangType,
					userDataType:"1",
					},
					flag:"2"
					}
					)
				} else if(type == 2) {
					var data=JSON.stringify({
						reqData:{
						userId:personId,
						questionType:2,
						lastReply:msg,
						qaType:suifangType,
						userDataType:"2",
						format:"amr",
						rate:"8000"
						},
						flag:"2"
						})
				}
				
					// console.log(data)
					mui.ajax(JTURL + '/jkda/heathai/heathAiConversion', {
					data:data,
					dataType: 'json', //æœåŠ¡å™¨è¿”å›jsonæ ¼å¼æ•°æ®
					headers:{'Content-Type':'application/json'},	
					type: 'post', //HTTPè¯·æ±‚ç±»å‹
					timeout: 10000, //è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10ç§’ï¼›
					success: function(res) {
						// plus.nativeUI.closeWaiting();
						// console.log(JSON.stringify(res));			
						if (res.code == 0) {
						// var list = res.resData;
						// var list = res.resData.replace(/\\"/g,'');
						// var question = list.resData.question;
						console.log(JSON.stringify(res.question))
						/* app.reply = res.reply;
						app.remind = res.remind; */
					/* 	if(res.reply!=""&&res.remind=="") {
							app.flag = 2;
							console.log(1)
						} else if(res.remind!=""&&res.reply=="") {
							app.flag = 3;
							console.log(2)
						} else if(res.reply!=""&&res.remind!=""){
							app.flag = 4;
							console.log(3)
						}else if(res.reply==""&&res.remind==""){
							app.flag = 5;
							console.log(4)
						} */
						if(type == 1) {
							var obj = {
								senderId: 2,
								// senderId: app.chatUserId,
								// senderName: app.chatUserName,
								senderName: 'éšè®¿æŠ¤å£«',
								content: res.question,
								remind: res.remind,
								reply: res.reply,
								tag:res.tag,
								msgType: "text"
							};
							app.chatList.push(obj);
						}
						else if(type == 2) {
							var base64Str = res.video;
							var toURL;
							// å½•éŸ³å®Œæ¯•,ä¿å­˜åœ¨æœ¬åœ°,å¹¶å±•ç¤ºåœ¨é¡µé¢
							var l = 60 - microphoneNum.innerHTML; // è¯­éŸ³é•¿åº¦
							var widthNum = plus.display.resolutionWidth * 0.9 - 100;
							var ratio = (widthNum - 50) / 60;
							
							// console.log(ratio);
						dataURL2Audio(base64Str, function(entry){
								toURL = entry.toURL();	
								app.audio = toURL;
								console.log(app.audio)
								var obj = {
										// senderId: app.chatUserId,
										senderId: 2,
										senderName: 'éšè®¿æŠ¤å£«',
										// voicePath: audioPath,
										voicePath: app.audio,
										// duration: l + "s",
										duration: "ğŸ”Š",
										msgType: "voice",
										widthLength: ratio * l + 50 + "px",
										isPlay: 0
									};
								app.chatList.push(obj);
								// æ’­æ”¾éŸ³é¢‘
								// playAudio(toURL);
						})
						
						}						
						
						chatscroll();						
						} else if (res.code == 401) {
							ajaxTokenInvalid();
						} else {
							otherErr();
						}
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						ajaxError();
					}
				});
			}
			//è‡ªåŠ¨æ»šåŠ¨(ç›‘å¬èŠå¤©å†…å®¹æ˜¯å¦åˆ°è¾¾æœ€åº•éƒ¨)
			function chatscroll() {
				setTimeout(function() {
					chatContentBox.scrollTop = chatContentBox.scrollHeight;					
				}, 10)
				if(chatContentBox.scrollTop >= chatContentBox.scrollHeight) {
                   chatContentBox.scrollTop = 0;
                   // console.log(1)
               } else {
					chatContentBox.scrollTop = chatContentBox.scrollHeight + "px"
					// console.log(2)
               }
			   
			}

			// åˆå§‹åŒ–
			function chatWindowInit() {
				// è·å–çª—å£é«˜åº¦å¹¶è®¾ç½®èŠå¤©å†…å®¹æ˜¾ç¤ºåŒºåŸŸçš„å¤§å°
				chatContentBox.style.maxHeight = plus.screen.resolutionHeight - 45 - 75 + "px";
				chatContentBox.scrollTop = chatContentBox.scrollHeight;

				// åˆå§‹åŒ–å½•éŸ³
				audioObj = plus.audio.getRecorder();

				// è·å–å½“å‰ç”¨æˆ·çš„ID 
				// console.log(userId);
				app.chatUserId = userId;
			};

			// ç›‘å¬é¡µé¢æ»‘åŠ¨äº‹ä»¶
			chatContentBox.addEventListener("swipedown", function() {
				console.log(chatContentBox.scrollTop);
				if (chatContentBox.scrollTop == 0) {
					console.log("åˆ°é¡¶éƒ¨äº†,åŠ è½½ä¸‹ä¸€é¡µèŠå¤©è®°å½•");
				}
			});

			// ç‚¹å‡»åŠ è½½æ›´å¤šå†å²è®°å½•
			function loadingMore() {
				mui("#loadingMoreHistory").button('loading');
				/* mui.fire(msgPage, 'getHistory', {
					targetId: targetId
				}) */
			}

			// ä»msgé¡µé¢è¿”å›çš„å†å²è®°å½•åˆ—è¡¨
		/* 	window.addEventListener("gotHistoryList", function(e) {
				if(e.detail.historyList.length < 20){
					app.hasHistory = false
				}else{
					app.hasHistory = true
				}
				for (var i = 0; i < e.detail.historyList.length; i++) {
					var obj = {};
					if (e.detail.historyList[i].senderUserId == app.chatUserId) {
						obj.senderName = userName;
						obj.senderId = userId;
					} else {
						obj.senderName = document.getElementById("chatNameDom").innerHTML;
						obj.senderId = targetId;
					}

					obj.content = e.detail.historyList[i].content.content;

					if (e.detail.historyList[i].messageType = "TextMessage") {
						obj.msgType = "text"
					}
					app.chatList.unshift(obj);
				};
				setTimeout(function() {
					mui("#loadingMoreHistory").button('reset');
					app.$forceUpdate();
					chatContentBox.scrollTop = e.detail.historyList.length * 70;
					console.log(JSON.stringify(app.chatList));
				}, 10)

			}) */
			// ç›‘å¬å‘é€æŒ‰é’®
			sendBtn.addEventListener("tap", function() {
				
				
				var obj = {
					senderId: 3,
					// senderId: app.chatUserId,
					senderName: app.chatUserName,
					content: messageCon.value,
					msgType: "text",
					reply:"",
					remind:"",

				};
				app.chatList.push(obj);
				console.log(JSON.stringify(app.chatList))
				dataFlag = 1;
				console.log(dataFlag)
				chatwithInit(messageCon.value,dataFlag);

				// è®²å‘é€æ¶ˆæ¯çš„äº‹ä»¶å‘é€ç»™åˆ—è¡¨é¡µ
				/* mui.fire(msgPage, 'sendMsg', {
					targetId: targetId,
					content: messageCon.value
				}) */

				messageCon.blur();
				messageCon.value = "";
				moreIcon.style.display = "inline-block";
				sendBtn.style.display = "none";
				window.setTimeout(function() {
					chatContentBox.scrollTop = chatContentBox.scrollHeight;
				}, 100);
			}, {
				passive: false
			});
			

			// ç›‘å¬è¾“å…¥æ¡†   æ”¹å˜å‘é€ä¸æ›´å¤šåˆ‡æ¢
			messageCon.addEventListener("input", function() {
				if (messageCon.value == "") {
					moreIcon.style.display = "inline-block";
					sendBtn.style.display = "none";
				} else {
					moreIcon.style.display = "none";
					sendBtn.style.display = "block";
				}

			}, {
				passive: false
			})

			// ç›‘å¬æ›´å¤šæŒ‰é’®äº‹ä»¶,æ‰“å¼€æ›´å¤šåŠŸèƒ½
			/* moreIcon.addEventListener("tap", function() {
				if (morBox.style.display == "none") {
					// æ‰“å¼€æ›´å¤šåŠŸèƒ½
					morBox.style.display = "flex";
					chatContentBox.style.height = plus.screen.resolutionHeight - 45 - 185 + "px";
					footerContent.style.bottom = 115 + "px";
				} else {
					// éšè—æ›´å¤šåŠŸèƒ½
					morBox.style.display = "none";
					chatContentBox.style.height = plus.screen.resolutionHeight - 45 - 75 + "px";
					footerContent.style.bottom = 0;
				}

				// åˆ¤æ–­è¾“å…¥æ¡†æ˜¯å¦ä¸ºè·å–ç„¦ç‚¹çŠ¶æ€
				if (messageCon == document.activeElement) {
					messageCon.blur();
				}
			}, {
				passive: false
			}) */

			// è¾“å…¥æ¡†è·å–ç„¦ç‚¹çš„æ—¶å€™,å¼¹å‡ºè½¯é”®ç›˜,éšè—æ›´å¤šåŠŸèƒ½
			messageCon.addEventListener("focus", function() {
				// morBox.style.display = "none";
				document.getElementById("chatContentBox").style.height = plus.screen.resolutionHeight - 45 - 75 + "px";
				footerContent.style.bottom = 0;

			}, {
				passive: false
			});

			// ç‚¹å‡»èŠå¤©å†…å®¹åŒºåŸŸ ä½¿è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹  éšè—æ›´å¤šåŠŸèƒ½é€‰æ‹©åŒºåŸŸ
			chatContentBox.addEventListener("tap", function() {
				messageCon.blur(); // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
				// éšè—æ›´å¤šåŠŸèƒ½é€‰æ‹©åŒºåŸŸ
				// morBox.style.display = "none";
				document.getElementById("chatContentBox").style.height = plus.screen.resolutionHeight - 45 - 75 + "px";
				footerContent.style.bottom = 0;

			})

			// ç‚¹å‡»å‘é€è¯­éŸ³æŒ‰é’®
			voiceIconBox.addEventListener("tap", function() {
				voiceIconBox.style.display = "none";
				textIconBox.style.display = "block";
				messageCon.style.display = "none";
				holdToSpeak.style.display = "block";
			}, {
				passive: false
			});

			// ç‚¹å‡»æ–‡æœ¬ç¼–è¾‘æŒ‰é’®
			textIconBox.addEventListener("tap", function() {
				voiceIconBox.style.display = "block";
				textIconBox.style.display = "none";
				messageCon.style.display = "block";
				holdToSpeak.style.display = "none";
			}, {
				passive: false
			})

			// é•¿æŒ‰ "æŒ‰ä½è¯´è¯" æŒ‰é’®
			holdToSpeak.addEventListener("hold", function() {
				isHoldEven = true;
				console.log(isHoldEven);
				microphoneBox.style.display = "block";
				microphoneNum.innerHTML = "60";
				voiceTime = window.setInterval(function() {
					if (microphoneNum.innerHTML == 0) {
						microphoneBox.style.display = "none";
						window.clearInterval(voiceTime);
						// todo  ç›´æ¥å‘é€æ¶ˆæ¯

					} else {
						microphoneNum.innerHTML = microphoneNum.innerHTML - 1;
					}
				}, 1000);

				// å¼€å§‹å½•éŸ³
				if (audioObj == null) {
					alert("è®¾å¤‡å½•éŸ³å¼‚å¸¸,è¯·æ£€æŸ¥æ˜¯å¦æ”¯æŒå½•éŸ³åŠŸèƒ½");
					return;
				}
				audioObj.record({
					filename: "_doc/audio/"
				}, function(recordFile) {
					audioPath = recordFile;
					Audio2dataURL(recordFile)
					console.log(recordFile)
				}, function(e) {
					console.log("Audio record failed: " + e.message);
				});

			});
			
			//å°†base64è½¬æ¢ä¸ºè¯­éŸ³
			
			function dataURL2Audio (base64Str, callback) {
				var base64Str = base64Str.replace('data:audio/amr;base64,','');
				var audioName = (new Date()).valueOf() + '.amr';
				plus.io.requestFileSystem(plus.io.PRIVATE_DOC,function(fs){
					fs.root.getFile(audioName,{create:true},function(entry){
						// è·å¾—å¹³å°ç»å¯¹è·¯å¾„
						var fullPath = entry.fullPath;
						if(mui.os.android){  
							// è¯»å–éŸ³é¢‘
							var Base64 = plus.android.importClass("android.util.Base64");
							var FileOutputStream = plus.android.importClass("java.io.FileOutputStream");
							try{
								var out = new FileOutputStream(fullPath);
								var bytes = Base64.decode(base64Str, Base64.DEFAULT);
								out.write(bytes); 
								out.close();
								// å›è°ƒ
								callback && callback(entry);
							}catch(e){
								console.log(e.message);
							}
						}else if(mui.os.ios){
							var NSData = plus.ios.importClass('NSData');
							var nsData = new NSData();
							nsData = nsData.initWithBase64EncodedStringoptions(base64Str,0);
							if (nsData) {
								nsData.plusCallMethod({writeToFile: fullPath,atomically:true});
								plus.ios.deleteObject(nsData);
							}
							// å›è°ƒ
							callback && callback(entry);
						}
					})
				})
			}
			
			
			//å°†å£°éŸ³è½¬æ¢ä¸ºbase64
			var souce;
			function Audio2dataURL (path) {
				plus.io.resolveLocalFileSystemURL(path, function(entry){
					entry.file(function(file){
						var reader = new plus.io.FileReader();
						reader.onloadend = function (e) {
							console.log(e.target.result);
							var str = e.target.result;
							app.souce = str.substring(str.indexOf(',')+1);
							// console.log(souce);
						};
						reader.readAsDataURL(file);
					},function(e){
						mui.toast("è¯»å†™å‡ºç°å¼‚å¸¸: " + e.message );
					})
				})
			}
	

			// æ¾å¼€ "æŒ‰ä½è¯´è¯" æŒ‰é’®
			holdToSpeak.addEventListener("release", function() {
				// console.log(souce);
				if (isHoldEven == true) {
					// å…³é—­å½•éŸ³
					audioObj.stop();
					microphoneBox.style.display = "none";
					window.clearInterval(voiceTime);
					isHoldEven = false;
					setTimeout(function() {
						if (microphoneNum.innerHTML >= 60) {
							microphoneBoxShort.style.display = "block"
							var voiceShort = window.setTimeout(function() {
								microphoneBoxShort.style.display = "none";
							}, 1000);
						} else {
							microphoneBoxShort.style.display = "none";

							// å½•éŸ³å®Œæ¯•,ä¿å­˜åœ¨æœ¬åœ°,å¹¶å±•ç¤ºåœ¨é¡µé¢
							var l = 60 - microphoneNum.innerHTML; // è¯­éŸ³é•¿åº¦
							var widthNum = plus.display.resolutionWidth * 0.9 - 100;
							var ratio = (widthNum - 50) / 60;

							console.log(ratio);
							var obj = {
								// senderId: app.chatUserId,
								senderId: 3,
								senderName: app.chatUserName,
								voicePath: audioPath,
								// voicePath: souce,
								// duration: l + "s",
								duration:"ğŸ”Š",
								msgType: "voice",
								widthLength: ratio * l + 50 + "px",
								isPlay: 0
							};
							console.log(JSON.stringify(obj));
							app.chatList.push(obj);
							dataFlag = 2;
							chatwithInit(app.souce,dataFlag);
							window.setTimeout(function() {
								chatContentBox.scrollTop = chatContentBox.scrollHeight;
							}, 100)
						};
					}, 500)
				} else {
					microphoneBoxShort.style.display = "block"
					var voiceShort = window.setTimeout(function() {
						microphoneBoxShort.style.display = "none";
					}, 1000);
				}

			});

			// ç›‘å¬çˆ¶é¡µé¢ä¼ æ¥çš„æ¥æ”¶æ¶ˆæ¯
			/* window.addEventListener("receiveMsg", function(e) {
				var obj = {
					senderName: document.getElementById("chatNameDom").innerHTML,
					senderId: targetId,
					content: e.detail.content,
					msgType: e.detail.msgType
				};
				app.chatList.push(obj);
				setTimeout(function() {
					chatContentBox.scrollTop = chatContentBox.scrollHeight;
				}, 100)
				console.log(JSON.stringify(obj));
			}); */
		</script>
	</body>

</html>
